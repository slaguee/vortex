<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vortex</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800;900&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --p:#7c5cfc;--pd:#5e3fd6;--pl:rgba(124,92,252,0.15);
  --s:#fc5cbc;--a:#5ccefc;--a2:#00e5cc;
  --g:#3ba55d;--r:#ed4245;--y:#faa61a;
  --bg0:#080910;--bg1:#0f1015;--bg2:#14151b;--bg3:#1b1c25;--bg4:#23242f;--bg5:#2c2d3a;
  --tx:#e8eaed;--mu:#5c5f73;--mu2:#8b8fa8;
  --bdr:rgba(255,255,255,0.06);--bdr2:rgba(255,255,255,0.1);
  --sh:0 20px 60px rgba(0,0,0,.8);
  --glow:0 0 30px rgba(124,92,252,0.2);
  --tr:0.18s cubic-bezier(.4,0,.2,1);
  --glass:rgba(255,255,255,0.03);
}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden;font-family:'DM Sans',sans-serif;background:var(--bg0);color:var(--tx);font-size:15px}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--bg5);border-radius:3px}
.bfx{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden}
.bfx::before{content:'';position:absolute;top:-30%;left:-15%;width:60%;height:60%;background:radial-gradient(ellipse,rgba(124,92,252,.18)0%,transparent 65%);animation:bga 14s ease-in-out infinite alternate;filter:blur(40px)}
.bfx::after{content:'';position:absolute;bottom:-20%;right:-10%;width:50%;height:50%;background:radial-gradient(ellipse,rgba(252,92,188,.12)0%,transparent 65%);animation:bgb 18s ease-in-out infinite alternate;filter:blur(40px)}
.bfx .bfx3{position:absolute;top:40%;left:50%;width:30%;height:30%;background:radial-gradient(ellipse,rgba(92,206,252,.08)0%,transparent 65%);animation:bgc 22s ease-in-out infinite alternate;filter:blur(50px)}
@keyframes bga{from{transform:translate(0,0) scale(1)}to{transform:translate(6%,8%) scale(1.1)}}
@keyframes bgb{from{transform:translate(0,0) scale(1)}to{transform:translate(-7%,-5%) scale(1.15)}}
@keyframes bgc{from{transform:translate(-50%,-50%) scale(1)}to{transform:translate(-40%,-60%) scale(0.9)}}
body::after{content:'';position:fixed;inset:0;z-index:1;pointer-events:none;opacity:.025;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");background-size:128px}
#authWrap{position:relative;z-index:10;display:flex;align-items:center;justify-content:center;height:100vh;padding:16px}
.acard{background:linear-gradient(135deg,rgba(15,16,21,0.95),rgba(20,21,27,0.9));border:1px solid var(--bdr2);border-radius:20px;padding:36px 40px;width:100%;max-width:420px;box-shadow:var(--sh),var(--glow);backdrop-filter:blur(20px);position:relative;overflow:hidden}
.acard::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(124,92,252,0.05),transparent 50%,rgba(252,92,188,0.03));pointer-events:none}
.logo{font-family:'Syne',sans-serif;font-size:36px;font-weight:900;text-align:center;margin-bottom:6px;background:linear-gradient(135deg,#7c5cfc 0%,#fc5cbc 50%,#5ccefc 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;background-size:200%;animation:shine 4s linear infinite;letter-spacing:-1px}
.logomark{text-align:center;font-size:28px;margin-bottom:10px;animation:pulse 3s ease-in-out infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
@keyframes shine{to{background-position:200% center}}
.atitle{text-align:center;font-size:22px;font-weight:700;margin-bottom:3px}
.asub{text-align:center;color:var(--mu2);font-size:13px;margin-bottom:24px}
.fld{margin-bottom:16px}
.fld label{display:block;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--mu2);margin-bottom:6px}
.fld label span{color:var(--r)}
input[type=text],input[type=email],input[type=password],input[type=number],select,textarea{width:100%;padding:10px 14px;background:rgba(255,255,255,0.04);border:1.5px solid var(--bdr2);border-radius:10px;color:var(--tx);font-family:'DM Sans',sans-serif;font-size:15px;transition:all var(--tr)}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--p);background:rgba(124,92,252,0.05);box-shadow:0 0 0 3px rgba(124,92,252,0.1)}
input::placeholder,textarea::placeholder{color:var(--mu)}
select option{background:var(--bg3)}
.err{color:var(--r);font-size:12px;margin-top:5px;display:none}.err.on{display:block}
.btn{width:100%;padding:11px;background:linear-gradient(135deg,var(--p),var(--pd));border:none;border-radius:10px;color:#fff;font-family:'DM Sans',sans-serif;font-size:15px;font-weight:600;cursor:pointer;transition:all var(--tr);position:relative;overflow:hidden}
.btn::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,0.1),transparent);opacity:0;transition:opacity var(--tr)}
.btn:hover::before{opacity:1}.btn:hover{transform:translateY(-1px);box-shadow:0 8px 25px rgba(124,92,252,0.35)}
.btn:active{transform:translateY(0)}.btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
.btn.danger{background:linear-gradient(135deg,var(--r),#c62d30)}.btn.danger:hover{box-shadow:0 8px 25px rgba(237,66,69,0.35)}
.btn.sec{background:var(--bg4);color:var(--tx);box-shadow:none}.btn.sec:hover{background:var(--bg5);transform:translateY(-1px)}
.btn.sm{padding:7px 16px;font-size:14px;width:auto}.btn.xs{padding:5px 10px;font-size:13px;width:auto}
.alink{text-align:center;margin-top:12px;font-size:13px;color:var(--mu)}.alink a{color:var(--p);cursor:pointer;font-weight:600}.alink a:hover{text-decoration:underline}
.capbox{background:rgba(255,255,255,0.03);border:2px solid var(--bdr2);border-radius:14px;padding:28px;margin-bottom:18px;text-align:center}
.capmath{font-size:36px;font-weight:900;font-family:'Syne',sans-serif;color:var(--a);margin-bottom:18px;letter-spacing:6px}
.capmath span{color:var(--s)}
.capinput{width:130px;font-size:28px;font-weight:700;text-align:center;border-radius:10px;padding:10px;margin:0 auto;display:block}
.caplabel{font-size:13px;color:var(--mu2);margin-bottom:14px}
#appWrap{position:relative;z-index:10;display:none;height:100vh}
#appWrap.on{display:flex}
.sbar{width:68px;background:var(--bg0);display:flex;flex-direction:column;align-items:center;padding:10px 0 10px;gap:5px;overflow-y:auto;flex-shrink:0;border-right:1px solid var(--bdr)}
.sico{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all var(--tr);font-size:20px;position:relative;flex-shrink:0;border:2px solid transparent;user-select:none;overflow:hidden;background:var(--bg3)}
.sico img,.sico video{width:100%;height:100%;object-fit:cover;border-radius:inherit}
.sico:hover,.sico.on{border-radius:16px;border-color:rgba(124,92,252,0.4)}
.sico.on{box-shadow:0 0 0 2px var(--p),0 0 20px rgba(124,92,252,0.3)}
.spip{position:absolute;left:-8px;top:50%;transform:translateY(-50%);width:4px;background:var(--tx);border-radius:0 4px 4px 0;transition:height var(--tr)}
.sico.on .spip{height:22px}.sico:hover:not(.on) .spip{height:8px}
.ssep{width:30px;height:1px;background:rgba(255,255,255,0.07);margin:2px 0;flex-shrink:0}
.cbar{width:240px;background:var(--bg1);display:flex;flex-direction:column;flex-shrink:0;border-right:1px solid var(--bdr)}
.chead{height:48px;padding:0 14px;border-bottom:1px solid var(--bdr);display:flex;align-items:center;justify-content:space-between;font-weight:700;font-size:14px;font-family:'Syne',sans-serif}
.chead button{background:none;border:none;color:var(--mu);cursor:pointer;font-size:18px;transition:color var(--tr);padding:2px;border-radius:6px}.chead button:hover{color:var(--tx);background:var(--bg4)}
.csrch{padding:8px}.csrch input{padding:7px 10px;font-size:13px;border-radius:8px}
.clist{flex:1;overflow-y:auto;padding:4px 6px}
.ccat{padding:14px 6px 4px;font-size:10px;font-weight:700;text-transform:uppercase;color:var(--mu);letter-spacing:1px;display:flex;align-items:center;justify-content:space-between}
.citem{display:flex;align-items:center;gap:8px;padding:6px 9px;border-radius:8px;cursor:pointer;margin-bottom:1px;transition:all var(--tr);color:var(--mu)}
.citem:hover{background:var(--glass);color:var(--mu2)}.citem.on{background:var(--bg4);color:var(--tx)}
.citem .ico{font-size:16px;flex-shrink:0}.citem .lbl{flex:1;font-size:14px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.dmitem{display:flex;align-items:center;gap:9px;padding:6px 9px;border-radius:8px;cursor:pointer;margin-bottom:2px;transition:all var(--tr)}
.dmitem:hover{background:var(--glass)}.dmitem.on{background:var(--bg4)}
.dminfo{flex:1;min-width:0}.dmname{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.dmstat{font-size:11px;color:var(--mu)}
.uarea{padding:8px;background:rgba(0,0,0,0.3);display:flex;align-items:center;gap:7px;border-top:1px solid var(--bdr)}
.uinfo{flex:1;min-width:0}.uname{font-size:13px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ustatus{font-size:10px;color:var(--mu);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.uctrls{display:flex;gap:1px}
.ub{width:30px;height:30px;border-radius:6px;background:none;border:none;color:var(--mu);cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:all var(--tr)}
.ub:hover{background:var(--bg4);color:var(--tx)}.ub.muted{color:var(--r)}
.ava{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;flex-shrink:0;position:relative;overflow:hidden}
.ava img,.ava video{width:100%;height:100%;object-fit:cover;border-radius:50%}
.ava.lg{width:40px;height:40px;font-size:16px}.ava.xl{width:72px;height:72px;font-size:28px}
.ava .dot{position:absolute;bottom:-1px;right:-1px;width:11px;height:11px;border-radius:50%;border:2px solid var(--bg1);z-index:2}
.ava .dot.on{background:var(--g)}.ava .dot.off{background:var(--mu)}
.main{flex:1;display:flex;flex-direction:column;background:var(--bg2);min-width:0}
.mhead{height:48px;padding:0 14px;border-bottom:1px solid var(--bdr);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;background:rgba(0,0,0,0.2);backdrop-filter:blur(10px)}
.mhead .ml{display:flex;align-items:center;gap:9px}.mhead .mn{font-size:15px;font-weight:700;font-family:'Syne',sans-serif}.mhead .ms{font-size:12px;color:var(--mu)}
.mhead .mr{display:flex;gap:3px}
.hb{background:none;border:none;color:var(--mu);cursor:pointer;font-size:18px;padding:6px;transition:all var(--tr);border-radius:6px}.hb:hover{color:var(--tx);background:var(--bg4)}
#vPanel{background:rgba(59,165,93,.08);border-bottom:1px solid rgba(59,165,93,.2);padding:10px 14px;display:none}
#vPanel.on{display:block}
.vprow{display:flex;align-items:center;gap:9px;margin-bottom:8px}
.vpt{font-size:14px;font-weight:700;color:var(--g);font-family:'Syne',sans-serif}.vps{font-size:11px;color:var(--mu2)}
.vpcards{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:7px}
.vpcard{background:var(--bg3);border:1px solid var(--bdr);border-radius:8px;padding:7px 11px;display:flex;align-items:center;gap:7px}
.vpcard .vn{font-size:13px;font-weight:600}
.vpctrls{display:flex;gap:5px}
.fhead{height:48px;padding:0 14px;border-bottom:1px solid var(--bdr);display:flex;align-items:center;gap:8px;flex-shrink:0;background:rgba(0,0,0,0.2)}
.ftab{background:none;border:none;color:var(--mu);font-family:'DM Sans',sans-serif;font-size:14px;font-weight:500;cursor:pointer;padding:5px 10px;border-radius:8px;transition:all var(--tr)}
.ftab:hover{background:var(--bg4);color:var(--tx)}.ftab.on{background:var(--bg4);color:var(--tx);font-weight:600}.ftab.add{color:var(--g);font-weight:600}
.fbody{flex:1;overflow-y:auto;padding:16px}
.frow{display:flex;align-items:center;gap:11px;padding:10px;border-radius:10px;border-bottom:1px solid var(--bdr);transition:background var(--tr)}
.frow:hover{background:var(--bg3)}.fri{flex:1;min-width:0}.frn{font-size:15px;font-weight:700}.frs{font-size:12px;color:var(--mu)}
.frbtns{display:flex;gap:5px}
.icob{width:34px;height:34px;border-radius:50%;background:var(--bg3);border:1px solid var(--bdr);color:var(--mu);cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:all var(--tr)}
.icob:hover{background:var(--bg4);color:var(--tx)}
.msgs{flex:1;overflow-y:auto;padding:8px 0}
.wscreen{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;text-align:center;padding:40px;gap:10px}
.wscreen h2{font-size:26px;font-weight:700;font-family:'Syne',sans-serif}.wscreen p{color:var(--mu);font-size:14px}
.mgroup{display:flex;gap:12px;padding:4px 14px;transition:background .1s;border-radius:4px;position:relative}
.mgroup:hover{background:rgba(0,0,0,.12)}
.mbody{flex:1;min-width:0}
.mhdr{display:flex;align-items:baseline;gap:7px;margin-bottom:2px}
.mhdr .auth{font-size:15px;font-weight:700;cursor:pointer;font-family:'Syne',sans-serif}.mhdr .auth:hover{text-decoration:underline}
.mhdr .ts{font-size:10px;color:var(--mu)}
.mtxt{font-size:15px;line-height:1.5;word-break:break-word;white-space:pre-wrap;color:rgba(232,234,237,0.9)}
.mattach{margin-top:6px;display:flex;flex-wrap:wrap;gap:6px}
.fattach{background:var(--bg3);border:1px solid var(--bdr);border-radius:8px;padding:8px 12px;display:flex;align-items:center;gap:8px;cursor:pointer;text-decoration:none;color:var(--tx);transition:all var(--tr);max-width:260px}
.fattach:hover{background:var(--bg4);border-color:var(--bdr2)}.fattach .fi{font-size:22px;flex-shrink:0}
.fattach .finfo{min-width:0}.fattach .fname{font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.fattach .fsz{font-size:10px;color:var(--mu)}
.imgattach{max-width:320px;max-height:240px;border-radius:10px;cursor:pointer;display:block;margin-top:5px;object-fit:cover;transition:all var(--tr);border:1px solid var(--bdr)}
.imgattach:hover{opacity:.9;border-color:var(--bdr2)}
.reactions{display:flex;flex-wrap:wrap;gap:4px;margin-top:5px}
.rxn{background:rgba(124,92,252,0.1);border:1px solid rgba(124,92,252,0.2);border-radius:12px;padding:3px 8px;font-size:13px;cursor:pointer;transition:all var(--tr);user-select:none;display:flex;align-items:center;gap:3px}
.rxn:hover{background:rgba(124,92,252,0.2);border-color:rgba(124,92,252,0.4);transform:scale(1.05)}
.rxn.mine{background:rgba(124,92,252,0.2);border-color:var(--p)}
.rxn .cnt{font-size:11px;color:var(--mu2);font-weight:600}
.rxnpick{position:absolute;right:12px;top:-38px;background:var(--bg3);border:1px solid var(--bdr2);border-radius:12px;padding:6px;display:none;gap:4px;z-index:50;box-shadow:var(--sh);animation:popIn 0.15s cubic-bezier(.34,1.56,.64,1)}
@keyframes popIn{from{opacity:0;transform:scale(0.8) translateY(4px)}to{opacity:1;transform:scale(1) translateY(0)}}
.rxnpick.on{display:flex}
.rxncell{font-size:20px;cursor:pointer;padding:4px;border-radius:6px;transition:all var(--tr)}
.rxncell:hover{background:var(--bg4);transform:scale(1.2)}
.mgroup:hover .rxnbtn{opacity:1}
.rxnbtn{opacity:0;position:absolute;right:14px;top:4px;background:var(--bg3);border:1px solid var(--bdr);border-radius:8px;padding:4px 6px;font-size:14px;cursor:pointer;transition:all var(--tr)}
.rxnbtn:hover{background:var(--bg4)}
.iwrap{padding:0 14px 12px;flex-shrink:0}
.ibox{background:var(--bg3);border-radius:12px;display:flex;align-items:flex-end;padding:8px 12px;gap:8px;border:1.5px solid var(--bdr);transition:all var(--tr)}
.ibox:focus-within{border-color:rgba(124,92,252,0.4);background:var(--bg4);box-shadow:0 0 0 3px rgba(124,92,252,0.08)}
.ibox textarea{flex:1;background:none;border:none;color:var(--tx);font-family:'DM Sans',sans-serif;font-size:15px;resize:none;max-height:120px;line-height:1.5}
.ibox textarea:focus{outline:none}
.ibox textarea::placeholder{color:var(--mu)}
.ib{background:none;border:none;color:var(--mu);cursor:pointer;font-size:19px;transition:all var(--tr);padding:3px;flex-shrink:0;border-radius:6px}
.ib:hover{color:var(--p);background:rgba(124,92,252,0.1)}
.fprev{display:flex;flex-wrap:wrap;gap:5px;padding:8px 14px 0;flex-shrink:0}
.fchip{background:var(--bg3);border:1px solid var(--bdr);border-radius:8px;padding:5px 8px;display:flex;align-items:center;gap:5px;font-size:12px;max-width:200px}
.fchip .fn{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:11px}
.fchip .rm{background:none;border:none;color:var(--r);cursor:pointer;font-size:12px}
.picker{position:absolute;bottom:70px;right:14px;width:330px;background:var(--bg2);border:1px solid var(--bdr2);border-radius:14px;box-shadow:var(--sh);z-index:50;overflow:hidden;animation:popIn 0.15s cubic-bezier(.34,1.56,.64,1)}
.pgrid{display:grid;grid-template-columns:repeat(8,1fr);gap:2px;padding:8px;max-height:250px;overflow-y:auto}
.ecell{padding:5px;font-size:22px;cursor:pointer;border-radius:6px;text-align:center;transition:all var(--tr)}
.ecell:hover{background:var(--bg4);transform:scale(1.15)}
.psrch{padding:8px 8px 4px}.psrch input{padding:6px 10px;font-size:13px}
.pcats{display:flex;overflow-x:auto;padding:4px 6px;gap:4px;flex-wrap:nowrap;scrollbar-width:none}
.pcats::-webkit-scrollbar{display:none}
.pcat{background:var(--bg4);border-radius:20px;padding:3px 10px;font-size:12px;cursor:pointer;white-space:nowrap;transition:all var(--tr);border:none;color:var(--mu2);font-family:'DM Sans',sans-serif}
.pcat:hover,.pcat.on{background:var(--p);color:#fff}
.ctxmenu{position:fixed;background:var(--bg2);border:1px solid var(--bdr2);border-radius:12px;padding:5px;box-shadow:var(--sh);z-index:200;min-width:190px;display:none;animation:popIn 0.12s ease}
.ctxmenu.on{display:block}
.ctxitem{display:flex;align-items:center;gap:9px;padding:8px 11px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;transition:background var(--tr);color:var(--tx)}
.ctxitem:hover{background:var(--bg4)}.ctxitem.danger{color:var(--r)}.ctxitem.danger:hover{background:rgba(237,66,69,.1)}
.ctxitem .ctxico{font-size:16px;width:20px;text-align:center}
.ctxsep{height:1px;background:var(--bdr);margin:4px 0}
#msidebar{width:230px;background:var(--bg1);display:none;flex-direction:column;flex-shrink:0;border-left:1px solid var(--bdr)}
#msidebar.on{display:flex}
.mshd{padding:12px 14px;border-bottom:1px solid var(--bdr);font-size:10px;font-weight:700;text-transform:uppercase;color:var(--mu);letter-spacing:1px;font-family:'Syne',sans-serif}
.mslist{flex:1;overflow-y:auto;padding:6px}
.msitem{display:flex;align-items:center;gap:9px;padding:6px 9px;border-radius:8px;cursor:pointer;transition:background var(--tr)}
.msitem:hover{background:var(--bg3)}.msitem .mn{font-size:14px;font-weight:600}.msitem .ms2{font-size:10px;color:var(--mu)}
.ov{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:100;backdrop-filter:blur(4px)}
.ov.on{display:flex}
.modal{background:var(--bg2);border-radius:16px;padding:26px 30px;max-width:480px;width:90%;box-shadow:var(--sh),var(--glow);border:1px solid var(--bdr2);max-height:90vh;overflow-y:auto}
.modal h2{font-size:20px;font-weight:700;margin-bottom:6px;font-family:'Syne',sans-serif}
.modal .sub{color:var(--mu2);font-size:13px;margin-bottom:18px;line-height:1.6}
.mbtns{display:flex;gap:7px;justify-content:flex-end;margin-top:16px}
.stabs{display:flex;gap:3px;margin-bottom:18px;border-bottom:1px solid var(--bdr);padding-bottom:8px;flex-wrap:wrap}
.stab{background:none;border:none;color:var(--mu2);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;cursor:pointer;padding:5px 10px;border-radius:8px;transition:all var(--tr)}
.stab:hover{background:var(--bg4);color:var(--tx)}.stab.on{background:var(--p);color:#fff;font-weight:600}
.spanel{display:none}.spanel.on{display:block}
.chtypes{display:flex;gap:8px;margin-bottom:12px}
.chtype{flex:1;padding:10px;background:var(--bg3);border:2px solid var(--bdr);border-radius:10px;cursor:pointer;text-align:center;transition:all var(--tr)}
.chtype:hover{border-color:rgba(124,92,252,0.4)}.chtype.on{border-color:var(--p);background:rgba(124,92,252,0.1)}
.chtype .ico{font-size:20px;margin-bottom:3px}.chtype .lbl{font-size:12px;font-weight:600}
.agrid{display:grid;grid-template-columns:repeat(5,1fr);gap:7px;margin-bottom:12px}
.aopt{width:100%;aspect-ratio:1;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;border:3px solid transparent;transition:all var(--tr)}
.aopt:hover{transform:scale(1.08)}.aopt.on{border-color:#fff;box-shadow:0 0 0 3px var(--p)}
.swrow{display:flex;gap:7px;flex-wrap:wrap;margin-top:5px}
.sw{width:28px;height:28px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:all var(--tr)}
.sw:hover{transform:scale(1.15)}.sw.on{border-color:#fff;box-shadow:0 0 0 3px var(--p)}
.invbox{background:var(--bg3);border:1.5px solid var(--bdr2);border-radius:10px;padding:12px 14px;display:flex;align-items:center;gap:9px;margin-bottom:12px;font-size:13px;font-family:monospace;word-break:break-all}
.invbox .lnk{flex:1;color:var(--a)}
.invbox button{background:linear-gradient(135deg,var(--p),var(--pd));border:none;border-radius:7px;color:#fff;font-size:12px;font-weight:700;cursor:pointer;padding:5px 10px;white-space:nowrap;font-family:'DM Sans',sans-serif}
input[type=range]{-webkit-appearance:none;width:100%;height:4px;border-radius:2px;background:var(--bg5);outline:none;cursor:pointer;margin-top:4px}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:var(--p);cursor:pointer;box-shadow:0 0 6px rgba(124,92,252,0.4)}
.micbar{height:6px;background:var(--bg4);border-radius:3px;overflow:hidden;margin-top:6px}
.micfill{height:100%;background:var(--g);border-radius:3px;width:0%;transition:width .08s}
.avaprev{position:relative;display:inline-block;cursor:pointer}
.avaprev:hover .ava-overlay{opacity:1}
.ava-overlay{position:absolute;inset:0;border-radius:50%;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity var(--tr);font-size:18px;cursor:pointer}
.srv-banner-wrap{position:relative;border-radius:10px;overflow:hidden;margin-bottom:14px;background:var(--bg4);height:100px;display:flex;align-items:center;justify-content:center;cursor:pointer;border:2px dashed var(--bdr2);transition:all var(--tr)}
.srv-banner-wrap:hover{border-color:var(--p)}
.srv-banner-wrap img,.srv-banner-wrap video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
.srv-banner-txt{font-size:13px;color:var(--mu);text-align:center;position:relative;z-index:1}
.srv-ico-prev{width:64px;height:64px;border-radius:50%;overflow:hidden;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:28px;cursor:pointer;border:3px solid var(--bg2);position:relative;transition:all var(--tr)}
.srv-ico-prev:hover{border-color:var(--p)}
.srv-ico-prev img,.srv-ico-prev video{width:100%;height:100%;object-fit:cover}
.srv-ico-overlay{position:absolute;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;font-size:16px;opacity:0;transition:opacity var(--tr);border-radius:50%}
.srv-ico-prev:hover .srv-ico-overlay{opacity:1}
.callui{text-align:center}
.callui .cava{font-size:56px;margin-bottom:12px;animation:pulse 2s ease-in-out infinite}
.callui h2{font-size:22px;font-weight:700;font-family:'Syne',sans-serif;margin-bottom:5px}
.callui .cstat{font-size:13px;color:var(--mu);margin-bottom:22px}
.callbtns{display:flex;gap:14px;justify-content:center}
.cbtn{width:52px;height:52px;border-radius:50%;border:none;cursor:pointer;font-size:22px;display:flex;align-items:center;justify-content:center;transition:all var(--tr)}
.cbtn.end{background:linear-gradient(135deg,var(--r),#c62d30)}.cbtn.end:hover{transform:scale(1.08);box-shadow:0 6px 20px rgba(237,66,69,0.4)}
.cbtn.mic{background:var(--bg4);border:1px solid var(--bdr)}.cbtn.mic:hover{background:var(--bg5)}
#lbox{position:fixed;inset:0;background:rgba(0,0,0,.95);z-index:300;display:none;align-items:center;justify-content:center;cursor:zoom-out}
#lbox.on{display:flex}
#lbox img{max-width:90vw;max-height:90vh;border-radius:10px;box-shadow:var(--sh)}
#toast{position:fixed;bottom:24px;right:24px;background:var(--bg3);border:1px solid var(--bdr2);border-radius:12px;padding:11px 16px;font-size:13px;font-weight:600;z-index:999;transform:translateY(70px);opacity:0;transition:all .3s cubic-bezier(.34,1.56,.64,1);pointer-events:none;max-width:300px;backdrop-filter:blur(10px)}
#toast.on{transform:translateY(0);opacity:1}
#toast.ok{border-color:rgba(59,165,93,0.4);color:var(--g)}
#toast.err{border-color:rgba(237,66,69,0.4);color:var(--r)}
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px;text-align:center;color:var(--mu);gap:10px}
.empty .ei{font-size:52px;opacity:.25}.empty .et{font-size:17px;font-weight:700;color:var(--tx);font-family:'Syne',sans-serif}.empty .es{font-size:13px}
.joinbox{background:var(--bg3);border:1.5px solid var(--bdr2);border-radius:12px;padding:16px;margin-bottom:16px}
.srv-header{position:relative;overflow:hidden;flex-shrink:0}
/* Loading overlay */
#loadingOverlay{position:fixed;inset:0;background:var(--bg0);z-index:500;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px}
.spinner{width:40px;height:40px;border:3px solid var(--bg4);border-top-color:var(--p);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<div class="bfx"><div class="bfx3"></div></div>
<div id="toast"></div>
<div id="lbox" onclick="closeLbox()"><img id="lboxImg"></div>
<div id="loadingOverlay"><div class="spinner"></div><div style="color:var(--mu);font-size:14px">Connexion √† Firebase...</div></div>

<!-- CONTEXT MENU -->
<div class="ctxmenu" id="ctxMenu"><div id="ctxContent"></div></div>

<!-- AUTH -->
<div id="authWrap" style="display:none">
<div class="acard">
  <div class="logomark">‚ö°</div>
  <div class="logo">VORTEX</div>
  <div class="atitle" id="atitle">Cr√©er un compte</div>
  <div class="asub" id="asub">Rejoins la communaut√© !</div>

  <div id="regForm">
    <div class="fld"><label>Pseudo <span>*</span></label><input id="rPseudo" type="text" placeholder="CoolGamer42" maxlength="24"><div class="err" id="rPErr">Pseudo requis (2 min)</div></div>
    <div class="fld"><label>Email <span>*</span></label><input id="rEmail" type="email" placeholder="moi@email.com"><div class="err" id="rEErr">Email invalide</div></div>
    <div class="fld"><label>Mot de passe <span>*</span></label><input id="rPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"><div class="err" id="rPassErr">6 caract√®res minimum</div></div>
    <button class="btn" id="regBtn" onclick="Auth.register()">Continuer ‚Üí</button>
    <div class="alink">D√©j√† un compte ? <a onclick="Auth.showLogin()">Se connecter</a></div>
  </div>

  <div id="capForm" style="display:none">
    <div class="capbox">
      <div class="caplabel">Prouvez que vous n'√™tes pas un robot ü§ñ</div>
      <div class="capmath" id="capMath"></div>
      <input class="capinput" id="capAns" type="number" placeholder="?" min="0" max="999">
      <div class="err" id="capErr" style="margin-top:8px">Mauvaise r√©ponse !</div>
    </div>
    <button class="btn" onclick="Auth.verifyCap()">V√©rifier ‚úì</button>
  </div>

  <div id="loginForm" style="display:none">
    <div class="fld"><label>Email <span>*</span></label><input id="lEmail" type="email" placeholder="moi@email.com"><div class="err" id="lErr">Email ou mot de passe incorrect</div></div>
    <div class="fld"><label>Mot de passe <span>*</span></label><input id="lPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
    <button class="btn" onclick="Auth.login()">Connexion</button>
    <div class="alink">Pas de compte ? <a onclick="Auth.showRegister()">S'inscrire</a></div>
  </div>
</div>
</div>

<!-- APP -->
<div id="appWrap">
  <div class="sbar" id="sbar">
    <div class="sico on" id="homeBtn" onclick="App.showHome()" title="Messages Priv√©s">‚ö°<div class="spip"></div></div>
    <div class="ssep"></div>
    <div id="srvList"></div>
    <div class="sico" onclick="openModal('addSrvModal')" title="Cr√©er / Rejoindre" style="color:var(--g);font-size:24px;font-weight:700">+<div class="spip"></div></div>
  </div>

  <div class="cbar">
    <div class="chead">
      <span id="cheadTitle">Messages Priv√©s</span>
      <button id="cheadBtn" onclick="App.clickHead()" style="display:none">‚öôÔ∏è</button>
    </div>
    <div class="csrch" id="csrch"><input placeholder="üîç Rechercher" id="srchIn"></div>
    <div class="clist" id="clist"></div>
    <div class="uarea">
      <div class="avaprev" onclick="Settings.open()">
        <div class="ava" id="uAva" style="background:var(--p)"><div class="dot on"></div></div>
        <div class="ava-overlay">‚úèÔ∏è</div>
      </div>
      <div class="uinfo" onclick="Settings.open()" style="cursor:pointer">
        <div class="uname" id="uName"></div>
        <div class="ustatus" id="uStatus">En ligne</div>
      </div>
      <div class="uctrls">
        <button class="ub" id="micBtn" title="Micro" onclick="Voice.toggleMic()">üé§</button>
        <button class="ub" id="audioBtn" title="Audio" onclick="Voice.toggleAudio()">üîä</button>
        <button class="ub" title="Param√®tres" onclick="Settings.open()">‚öôÔ∏è</button>
      </div>
    </div>
  </div>

  <div class="main" id="main">
    <div class="fhead" id="fhead">
      <button class="ftab on" onclick="Friends.tab('online',this)">En ligne</button>
      <button class="ftab" onclick="Friends.tab('all',this)">Tous</button>
      <button class="ftab" onclick="Friends.tab('pending',this)" id="pendTab">En attente</button>
      <button class="ftab add" onclick="openModal('addFriendModal')">+ Ajouter</button>
    </div>
    <div class="mhead" id="mhead" style="display:none">
      <div class="ml">
        <div class="ava" id="mhAva" style="background:var(--p)"></div>
        <div><div class="mn" id="mhName"></div><div class="ms" id="mhSub"></div></div>
      </div>
      <div class="mr">
        <button class="hb" id="inviteBtn" onclick="App.showInvite()" style="display:none">üîó</button>
        <button class="hb" onclick="App.toggleMembers()">üë•</button>
      </div>
    </div>
    <div id="vPanel">
      <div class="vprow">
        <span style="font-size:22px">üîä</span>
        <div><div class="vpt" id="vpName">Vocal</div><div class="vps" id="vpStat">Connect√©</div></div>
        <button class="btn sm danger" style="margin-left:auto" onclick="Voice.leave()">üìµ Raccrocher</button>
      </div>
      <div class="vpcards" id="vpCards"></div>
    </div>
    <div style="flex:1;overflow:hidden;display:flex;flex-direction:column;position:relative">
      <div class="fbody" id="fbody"></div>
      <div class="msgs" id="msgsArea" style="display:none"></div>
    </div>
    <div class="fprev" id="fprev"></div>
    <div class="iwrap" id="iwrap" style="display:none;position:relative">
      <div class="ibox">
        <button class="ib" onclick="FH.pick()">üìé</button>
        <input type="file" id="fileInput" multiple style="display:none" accept="*/*" onchange="FH.onPick(this)">
        <textarea id="msgInput" placeholder="Envoyer un message..." rows="1" oninput="autoGrow(this)" onkeydown="Msg.onKey(event)"></textarea>
        <button class="ib" id="emojiBtn" onclick="Picker.toggle()">üòä</button>
        <button class="ib" onclick="Msg.send()" style="color:var(--p)">‚û§</button>
      </div>
      <div class="picker" id="picker" style="display:none">
        <div class="psrch"><input id="esrch" placeholder="Rechercher..." oninput="Picker.search(this.value)"></div>
        <div class="pcats" id="pcats"></div>
        <div class="pgrid" id="egrid"></div>
      </div>
    </div>
  </div>

  <div id="msidebar">
    <div class="mshd">Membres</div>
    <div class="mslist" id="mslist"></div>
  </div>
</div>

<!-- MODALS -->
<div class="ov" id="addFriendModal" onclick="oOut(event,'addFriendModal')">
<div class="modal">
  <h2>Ajouter un ami</h2>
  <div class="sub">Cherchez par pseudo exact.</div>
  <div class="fld"><label>Pseudo</label><input id="afPseudo" type="text" placeholder="CoolGamer42"><div class="err" id="afErr"></div></div>
  <div class="mbtns">
    <button class="btn sm sec" onclick="closeModal('addFriendModal')">Fermer</button>
    <button class="btn sm" onclick="Friends.sendRequest()">Envoyer ‚Üí</button>
  </div>
</div>
</div>

<div class="ov" id="settingsModal" onclick="oOut(event,'settingsModal')">
<div class="modal" style="max-width:520px">
  <h2>Param√®tres</h2>
  <div class="stabs">
    <button class="stab on" onclick="stab('Profile',this)">üë§ Profil</button>
    <button class="stab" onclick="stab('Security',this)">üîí S√©curit√©</button>
    <button class="stab" onclick="stab('Audio',this)">üîä Audio</button>
  </div>
  <div class="spanel on" id="stProfile">
    <div class="fld">
      <label>Photo de profil</label>
      <div style="display:flex;align-items:center;gap:16px;margin-bottom:12px">
        <div class="avaprev" style="width:72px;height:72px">
          <div class="ava xl" id="stAvaPreview" style="background:var(--p)"></div>
          <div class="ava-overlay" onclick="document.getElementById('ppUpload').click()">üì∑</div>
        </div>
        <div style="flex:1">
          <input type="file" id="ppUpload" accept="image/*" style="display:none" onchange="Settings.handlePP(this)">
          <button class="btn sm" onclick="document.getElementById('ppUpload').click()">üì∑ Choisir</button>
          <div style="font-size:11px;color:var(--mu);margin-top:2px">Max 1MB</div>
        </div>
      </div>
    </div>
    <div class="fld"><label>Couleur de fond</label><div class="swrow" id="swrow"></div></div>
    <div class="fld"><label>Emoji avatar</label><div class="agrid" id="agrid"></div></div>
    <div class="fld"><label>Nouveau pseudo</label><input id="stPseudo" type="text"></div>
    <div class="fld"><label>Statut personnalis√©</label><input id="stStatusTxt" type="text" placeholder="üéÆ En train de jouer..." maxlength="60"></div>
    <div class="fld"><label>Mot de passe actuel <span style="color:var(--r)">*</span></label><input id="stPC" type="password"><div class="err" id="stPE"></div></div>
    <button class="btn" onclick="Settings.saveProfile()">Sauvegarder</button>
  </div>
  <div class="spanel" id="stSecurity">
    <div class="fld"><label>Ancien mot de passe</label><input id="stOP" type="password"></div>
    <div class="fld"><label>Nouveau mot de passe</label><input id="stNP" type="password"></div>
    <div class="fld"><label>Confirmer</label><input id="stNP2" type="password"><div class="err" id="stPE2"></div></div>
    <button class="btn" onclick="Settings.changePass()" style="margin-bottom:12px">Changer le mot de passe</button>
    <hr style="border-color:var(--bdr);margin-bottom:12px">
    <button class="btn danger" onclick="Auth.logout()">Se d√©connecter</button>
  </div>
  <div class="spanel" id="stAudio">
    <div class="fld"><label>Microphone</label><select id="micDev"><option>Chargement...</option></select></div>
    <div class="fld"><label>Sensibilit√© micro</label><input type="range" id="micGain" min="0" max="200" value="100"></div>
    <button class="btn sec" onclick="Voice.testMic()" style="margin-bottom:6px">üé§ Tester</button>
    <button class="btn sec" onclick="Voice.stopTest()">‚èπ Arr√™ter</button>
    <div class="micbar"><div class="micfill" id="micFill"></div></div>
  </div>
  <div class="mbtns"><button class="btn sm sec" onclick="closeModal('settingsModal')">Fermer</button></div>
</div>
</div>

<div class="ov" id="addSrvModal" onclick="oOut(event,'addSrvModal')">
<div class="modal">
  <h2>Serveurs</h2>
  <div class="stabs">
    <button class="stab on" onclick="sstab('create',this)">Cr√©er</button>
    <button class="stab" onclick="sstab('join',this)">Rejoindre</button>
  </div>
  <div class="spanel on" id="spCreate">
    <div class="fld"><label>Emoji ic√¥ne</label><input id="srvIcon" type="text" placeholder="üéÆ" maxlength="2"></div>
    <div class="fld"><label>Nom <span style="color:var(--r)">*</span></label><input id="srvName" type="text" placeholder="Mon serveur"><div class="err" id="srvErr"></div></div>
    <button class="btn" onclick="Servers.create()">Cr√©er üöÄ</button>
  </div>
  <div class="spanel" id="spJoin">
    <div class="fld">
      <label>Code d'invitation</label>
      <input id="joinCode" type="text" placeholder="Ex: ABC12345">
      <div class="err" id="joinErr"></div>
    </div>
    <button class="btn" onclick="Servers.join()">Rejoindre ‚Üí</button>
  </div>
</div>
</div>

<div class="ov" id="srvSetModal" onclick="oOut(event,'srvSetModal')">
<div class="modal" style="max-width:500px">
  <h2>Param√®tres du serveur</h2>
  <div class="stabs">
    <button class="stab on" onclick="srvstab('gen',this)">G√©n√©ral</button>
    <button class="stab" onclick="srvstab('chs',this)">Salons</button>
    <button class="stab" onclick="srvstab('inv',this)">Invitations</button>
  </div>
  <div class="spanel on" id="srvGen">
    <div class="fld"><label>Emoji ic√¥ne</label><input id="seIcon" type="text" maxlength="2"></div>
    <div class="fld"><label>Nom du serveur</label><input id="seName" type="text"></div>
    <button class="btn" onclick="Servers.save()" style="margin-bottom:12px">Sauvegarder</button>
    <hr style="border-color:var(--bdr);margin-bottom:12px">
    <button class="btn danger" onclick="Servers.del()">Supprimer le serveur</button>
  </div>
  <div class="spanel" id="srvChs">
    <div class="chtypes">
      <div class="chtype on" id="ctTxt" onclick="Servers.chType('text',this)"><div class="ico">üí¨</div><div class="lbl">Texte</div></div>
      <div class="chtype" id="ctVoice" onclick="Servers.chType('voice',this)"><div class="ico">üîä</div><div class="lbl">Vocal</div></div>
    </div>
    <div class="fld"><label>Nom du salon <span style="color:var(--r)">*</span></label><input id="newCh" type="text" placeholder="g√©n√©ral"><div class="err" id="chErr"></div></div>
    <button class="btn" onclick="Servers.addCh()">Ajouter ‚úì</button>
    <hr style="border-color:var(--bdr);margin:14px 0">
    <div id="chManage"></div>
  </div>
  <div class="spanel" id="srvInv">
    <div class="sub">Partagez ce code pour inviter des membres.</div>
    <div class="invbox"><span class="lnk" id="invLinkTxt" style="font-size:20px;font-weight:900;letter-spacing:4px"></span><button onclick="copyInvite()">Copier</button></div>
    <button class="btn sec" onclick="Servers.regen()">üîÑ Nouveau code</button>
  </div>
  <div class="mbtns"><button class="btn sm sec" onclick="closeModal('srvSetModal')">Fermer</button></div>
</div>
</div>

<div class="ov" id="inviteModal" onclick="oOut(event,'inviteModal')">
<div class="modal" style="max-width:420px">
  <h2>Inviter des membres</h2>
  <div class="sub">Partagez ce code d'invitation :</div>
  <div class="invbox"><span class="lnk" id="invModalLink" style="font-size:24px;font-weight:900;letter-spacing:4px"></span><button onclick="copyInviteModal()">Copier</button></div>
  <div class="mbtns"><button class="btn sm sec" onclick="closeModal('inviteModal')">Fermer</button></div>
</div>
</div>

<!-- Firebase SDKs -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword, EmailAuthProvider, reauthenticateWithCredential } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getDatabase, ref, set, get, push, update, remove, onValue, onChildAdded, off, query, orderByChild, equalTo, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAOkPp9ct4IOl4n_b9b-jHT44ZNGFnwbd8",
  authDomain: "vortex-7d3c0.firebaseapp.com",
  databaseURL: "https://vortex-7d3c0-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "vortex-7d3c0",
  storageBucket: "vortex-7d3c0.firebasestorage.app",
  messagingSenderId: "738482533248",
  appId: "1:738482533248:web:2c4acc5dfab3a88a704765"
};

const fbApp = initializeApp(firebaseConfig);
const fbAuth = getAuth(fbApp);
const db = getDatabase(fbApp);

// ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ
const COLORS=['#7c5cfc','#fc5cbc','#5ccefc','#3ba55d','#faa61a','#ed4245','#eb459e','#00d4aa','#ff6b35','#f47fff'];
const EMOJIS=['üòÄ','üòé','üê±','üê∂','ü¶ä','üêº','ü¶Å','üê∏','üêß','ü¶Ö','üéÆ','‚ö°','üåô','üî•','üíé','üöÄ','üëæ','üéµ','üåà','ü¶ã'];
const QUICK_RXNS=['üëç','‚ù§Ô∏è','üòÇ','üî•','üòÆ','üëè','üéâ','üíØ'];

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
function esc(t){const d=document.createElement('div');d.textContent=t||'';return d.innerHTML}
function randColor(){return COLORS[Math.floor(Math.random()*COLORS.length)]}
function toast(msg,type='ok'){const t=document.getElementById('toast');t.textContent=msg;t.className='on '+(type==='err'?'err':'ok');clearTimeout(t._t);t._t=setTimeout(()=>t.className='',3200)}
function openModal(id){document.getElementById(id).classList.add('on')}
function closeModal(id){document.getElementById(id).classList.remove('on')}
function oOut(e,id){if(e.target===document.getElementById(id))closeModal(id)}
function fmtT(ts){if(!ts)return'';return new Date(ts).toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}
function autoGrow(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,120)+'px'}
function fmtSize(b){if(b<1024)return b+'B';if(b<1048576)return(b/1024).toFixed(1)+'KB';return(b/1048576).toFixed(1)+'MB'}
function getExt(n){return(n||'').split('.').pop().toLowerCase()}
function isImg(n){return['png','jpg','jpeg','gif','webp','svg'].includes(getExt(n))}
function fIcon(n){const m={pdf:'üìÑ',doc:'üìù',docx:'üìù',xls:'üìä',xlsx:'üìä',mp3:'üéµ',mp4:'üé¨',zip:'üì¶',txt:'üìÉ'};return m[getExt(n)]||'üìÅ'}
function closeLbox(){document.getElementById('lbox').classList.remove('on')}
window.closeLbox=closeLbox;
function emptyH(ico,t,s){return`<div class="empty"><div class="ei">${ico}</div><div class="et">${t}</div><div class="es">${s}</div></div>`}
function genCode(){return Math.random().toString(36).slice(2,10).toUpperCase()}

function mkAva(u,cls=''){
  const d=document.createElement('div');d.className='ava '+(cls||'');
  d.style.background=u.avaColor||'#7c5cfc';
  if(u.avaPic){
    const img=document.createElement('img');img.src=u.avaPic;img.alt=u.pseudo||'';
    d.innerHTML='';d.appendChild(img);
  } else {
    d.textContent=u.avaEmoji||(u.pseudo||'?')[0].toUpperCase();
  }
  const dot=document.createElement('div');dot.className='dot on';d.appendChild(dot);
  return d;
}

function fileToDataURL(f,maxMB=1){
  return new Promise((res,rej)=>{
    if(f.size>maxMB*1024*1024){rej(new Error('Fichier trop lourd (max '+maxMB+'MB)'));return}
    const fr=new FileReader();
    fr.onload=e=>{
      if(f.type.startsWith('image/')&&!f.type.includes('gif')){
        const img=new Image();img.onload=()=>{
          const canvas=document.createElement('canvas');
          const MAX=256;let w=img.width,h=img.height;
          if(w>MAX||h>MAX){if(w>h){h=h*MAX/w;w=MAX}else{w=w*MAX/h;h=MAX}}
          canvas.width=w;canvas.height=h;canvas.getContext('2d').drawImage(img,0,0,w,h);
          res(canvas.toDataURL('image/webp',0.8));
        };img.src=e.target.result;
      } else res(e.target.result);
    };fr.onerror=rej;fr.readAsDataURL(f);
  });
}

// Expose helpers globally
window.openModal=openModal;window.closeModal=closeModal;window.oOut=oOut;window.autoGrow=autoGrow;

// ‚îÄ‚îÄ TAB HELPERS ‚îÄ‚îÄ
function stab(name,btn){
  document.querySelectorAll('#settingsModal .stab').forEach(b=>b.classList.remove('on'));btn.classList.add('on');
  document.querySelectorAll('#settingsModal .spanel').forEach(p=>p.classList.remove('on'));
  document.getElementById('st'+name).classList.add('on');
  if(name==='Audio')Voice.loadDevices();
}
function sstab(name,btn){
  document.querySelectorAll('#addSrvModal .stab').forEach(b=>b.classList.remove('on'));btn.classList.add('on');
  document.getElementById('spCreate').classList[name==='create'?'add':'remove']('on');
  document.getElementById('spJoin').classList[name==='join'?'add':'remove']('on');
}
function srvstab(name,btn){
  document.querySelectorAll('#srvSetModal .stab').forEach(b=>b.classList.remove('on'));btn.classList.add('on');
  ['gen','chs','inv'].forEach(n=>{const el=document.getElementById('srv'+n.charAt(0).toUpperCase()+n.slice(1));if(el)el.classList.remove('on')});
  document.getElementById('srv'+name.charAt(0).toUpperCase()+name.slice(1)).classList.add('on');
  if(name==='inv'&&App.state.editSrv)document.getElementById('invLinkTxt').textContent=App.state.editSrv.code;
}
function copyInvite(){navigator.clipboard.writeText(document.getElementById('invLinkTxt').textContent).then(()=>toast('Code copi√© !'))}
function copyInviteModal(){navigator.clipboard.writeText(document.getElementById('invModalLink').textContent).then(()=>toast('Code copi√© !'))}
window.stab=stab;window.sstab=sstab;window.srvstab=srvstab;window.copyInvite=copyInvite;window.copyInviteModal=copyInviteModal;

// ‚îÄ‚îÄ CAPTCHA ‚îÄ‚îÄ
let capAnswer=null,capUserData=null;
function genCap(){
  const ops=['+','-','√ó'];const op=ops[Math.floor(Math.random()*3)];
  let a=Math.floor(Math.random()*20)+1,b=Math.floor(Math.random()*10)+1,ans;
  if(op==='+'){ans=a+b}else if(op==='-'){if(b>a)[a,b]=[b,a];ans=a-b}else{a=Math.floor(Math.random()*10)+1;b=Math.floor(Math.random()*10)+1;ans=a*b}
  return{expr:`${a} <span>${op}</span> ${b} = ?`,ans};
}

// ‚îÄ‚îÄ CTX MENU ‚îÄ‚îÄ
const CTX={
  show(x,y,items){
    const menu=document.getElementById('ctxMenu'),cont=document.getElementById('ctxContent');cont.innerHTML='';
    items.forEach(item=>{
      if(item==='-'){const sep=document.createElement('div');sep.className='ctxsep';cont.appendChild(sep);return}
      const el=document.createElement('div');el.className='ctxitem'+(item.danger?' danger':'');
      el.innerHTML=`<span class="ctxico">${item.ico||''}</span>${esc(item.label)}`;
      el.onclick=()=>{item.action();this.hide()};cont.appendChild(el);
    });
    menu.style.left=x+'px';menu.style.top=y+'px';menu.classList.add('on');
    requestAnimationFrame(()=>{const r=menu.getBoundingClientRect();if(r.right>innerWidth)menu.style.left=(x-r.width)+'px';if(r.bottom>innerHeight)menu.style.top=(y-r.height)+'px'});
  },
  hide(){document.getElementById('ctxMenu').classList.remove('on')}
};
document.addEventListener('click',()=>CTX.hide());
document.addEventListener('keydown',e=>{if(e.key==='Escape'){CTX.hide();closeLbox();Picker.close()}});

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ
const Auth={
  showRegister(){
    document.getElementById('atitle').textContent='Cr√©er un compte';
    document.getElementById('asub').textContent='Rejoins la communaut√© Vortex !';
    document.getElementById('regForm').style.display='block';
    document.getElementById('loginForm').style.display='none';
    document.getElementById('capForm').style.display='none';
  },
  showLogin(){
    document.getElementById('atitle').textContent='Bon retour !';
    document.getElementById('asub').textContent='Content de te revoir !';
    document.getElementById('loginForm').style.display='block';
    document.getElementById('regForm').style.display='none';
    document.getElementById('capForm').style.display='none';
  },
  async register(){
    const pseudo=document.getElementById('rPseudo').value.trim();
    const email=document.getElementById('rEmail').value.trim();
    const pass=document.getElementById('rPass').value;
    ['rPErr','rEErr','rPassErr'].forEach(id=>document.getElementById(id).classList.remove('on'));
    let ok=true;
    if(pseudo.length<2){document.getElementById('rPErr').classList.add('on');ok=false}
    if(!email.includes('@')){document.getElementById('rEErr').classList.add('on');ok=false}
    if(pass.length<6){document.getElementById('rPassErr').classList.add('on');ok=false}
    if(!ok)return;
    // Check pseudo uniqueness
    const snap=await get(query(ref(db,'users'),orderByChild('pseudoLower'),equalTo(pseudo.toLowerCase())));
    if(snap.exists()){document.getElementById('rPErr').textContent='Pseudo d√©j√† pris';document.getElementById('rPErr').classList.add('on');return}
    capUserData={pseudo,email,pass,avaColor:randColor(),avaEmoji:EMOJIS[Math.floor(Math.random()*EMOJIS.length)]};
    const cap=genCap();capAnswer=cap.ans;
    document.getElementById('capMath').innerHTML=cap.expr;
    document.getElementById('capAns').value='';
    document.getElementById('capErr').classList.remove('on');
    document.getElementById('regForm').style.display='none';
    document.getElementById('capForm').style.display='block';
  },
  async verifyCap(){
    const ans=parseInt(document.getElementById('capAns').value);
    document.getElementById('capErr').classList.remove('on');
    if(ans!==capAnswer){
      document.getElementById('capErr').classList.add('on');
      const cap=genCap();capAnswer=cap.ans;document.getElementById('capMath').innerHTML=cap.expr;document.getElementById('capAns').value='';return;
    }
    try{
      const cred=await createUserWithEmailAndPassword(fbAuth,capUserData.email,capUserData.pass);
      const uid=cred.user.uid;
      await set(ref(db,'users/'+uid),{
        id:uid,pseudo:capUserData.pseudo,pseudoLower:capUserData.pseudo.toLowerCase(),
        email:capUserData.email,avaColor:capUserData.avaColor,avaEmoji:capUserData.avaEmoji,
        avaPic:null,customStatus:'',createdAt:Date.now()
      });
      toast('Compte cr√©√© ! Bienvenue '+capUserData.pseudo+' üéâ');
    }catch(e){toast(e.message,'err');this.showRegister()}
  },
  async login(){
    const email=document.getElementById('lEmail').value.trim();
    const pass=document.getElementById('lPass').value;
    document.getElementById('lErr').classList.remove('on');
    try{
      await signInWithEmailAndPassword(fbAuth,email,pass);
    }catch{document.getElementById('lErr').classList.add('on')}
  },
  async logout(){
    if(!confirm('Se d√©connecter ?'))return;
    await signOut(fbAuth);
  }
};
window.Auth=Auth;

// ‚îÄ‚îÄ VOICE ‚îÄ‚îÄ
const Voice={
  st:{inVoice:false,ch:null,srv:null,micOn:true,audioOn:true,stream:null,test:null,gainNode:null},
  async loadDevices(){
    try{
      await navigator.mediaDevices.getUserMedia({audio:true});
      const devs=await navigator.mediaDevices.enumerateDevices();
      const mics=devs.filter(d=>d.kind==='audioinput');
      document.getElementById('micDev').innerHTML=mics.map((d,i)=>`<option value="${esc(d.deviceId)}">${esc(d.label||'Micro '+(i+1))}</option>`).join('');
    }catch{document.getElementById('micDev').innerHTML='<option>Acc√®s refus√©</option>'}
  },
  toggleMic(){
    this.st.micOn=!this.st.micOn;
    const btn=document.getElementById('micBtn');btn.textContent=this.st.micOn?'üé§':'üîá';btn.classList.toggle('muted',!this.st.micOn);
    if(this.st.stream)this.st.stream.getAudioTracks().forEach(t=>t.enabled=this.st.micOn);
    toast(this.st.micOn?'Micro activ√©':'Micro coup√©');
  },
  toggleAudio(){this.st.audioOn=!this.st.audioOn;document.getElementById('audioBtn').textContent=this.st.audioOn?'üîä':'üîá';document.getElementById('audioBtn').classList.toggle('muted',!this.st.audioOn)},
  async joinVoice(srv,ch){
    if(this.st.inVoice)this.leave(true);
    this.st.inVoice=true;this.st.ch=ch;this.st.srv=srv;
    try{this.st.stream=await navigator.mediaDevices.getUserMedia({audio:true});toast('üîä Connect√© √† "'+ch.name+'"')}
    catch{toast('‚ö†Ô∏è Micro non disponible','err')}
    this.updateVPanel();App.renderClist();
  },
  leave(silent=false){
    if(this.st.stream){this.st.stream.getTracks().forEach(t=>t.stop());this.st.stream=null}
    this.st.inVoice=false;this.st.ch=null;this.st.srv=null;
    document.getElementById('vPanel').classList.remove('on');
    if(!silent)toast('D√©connect√© du salon vocal');
    App.renderClist();
  },
  updateVPanel(){
    if(!this.st.inVoice){document.getElementById('vPanel').classList.remove('on');return}
    document.getElementById('vPanel').classList.add('on');
    document.getElementById('vpName').textContent=this.st.ch?.name||'Vocal';
    document.getElementById('vpStat').textContent='Connect√© ¬∑ micro '+(this.st.micOn?'actif':'coup√©');
  },
  async testMic(){
    try{
      this.st.test=await navigator.mediaDevices.getUserMedia({audio:true});
      const ctx=new AudioContext(),src=ctx.createMediaStreamSource(this.st.test),anal=ctx.createAnalyser();
      anal.fftSize=256;src.connect(anal);const data=new Uint8Array(anal.frequencyBinCount);
      const fill=document.getElementById('micFill');
      const tick=()=>{if(!this.st.test)return;anal.getByteFrequencyData(data);const vol=data.reduce((a,b)=>a+b,0)/data.length;fill.style.width=Math.min(100,vol*2)+'%';requestAnimationFrame(tick)};
      tick();
    }catch{toast('Acc√®s micro refus√©','err')}
  },
  stopTest(){if(this.st.test){this.st.test.getTracks().forEach(t=>t.stop());this.st.test=null}document.getElementById('micFill').style.width='0%'}
};
window.Voice=Voice;

// ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ
const Settings={
  _pendingPic:null,
  open(){
    const u=App.state.user;if(!u)return;
    document.getElementById('stPseudo').value=u.pseudo||'';
    document.getElementById('stStatusTxt').value=u.customStatus||'';
    this._pendingPic=null;
    const prev=document.getElementById('stAvaPreview');
    prev.style.background=u.avaColor||'#7c5cfc';
    if(u.avaPic){const img=document.createElement('img');img.src=u.avaPic;img.style.cssText='width:100%;height:100%;object-fit:cover;border-radius:50%';prev.innerHTML='';prev.appendChild(img)}
    else prev.textContent=u.avaEmoji||(u.pseudo||'?')[0].toUpperCase();
    const ag=document.getElementById('agrid');ag.innerHTML='';
    EMOJIS.forEach(em=>{const d=document.createElement('div');d.className='aopt'+(em===u.avaEmoji?' on':'');d.style.background=u.avaColor||'#7c5cfc';d.textContent=em;d.onclick=()=>{document.querySelectorAll('.aopt').forEach(x=>x.classList.remove('on'));d.classList.add('on')};ag.appendChild(d)});
    const sw=document.getElementById('swrow');sw.innerHTML='';
    COLORS.forEach(c=>{const d=document.createElement('div');d.className='sw'+(c===u.avaColor?' on':'');d.style.background=c;d.onclick=()=>{document.querySelectorAll('.sw').forEach(x=>x.classList.remove('on'));d.classList.add('on');document.querySelectorAll('.aopt').forEach(a=>a.style.background=c)};sw.appendChild(d)});
    document.querySelectorAll('#settingsModal .stab').forEach((b,i)=>b.classList[i===0?'add':'remove']('on'));
    document.querySelectorAll('#settingsModal .spanel').forEach((p,i)=>p.classList[i===0?'add':'remove']('on'));
    openModal('settingsModal');
  },
  async handlePP(inp){
    const f=inp.files[0];if(!f)return;
    try{
      const data=await fileToDataURL(f,1);
      this._pendingPic=data;
      const prev=document.getElementById('stAvaPreview');
      const img=document.createElement('img');img.src=data;img.style.cssText='width:100%;height:100%;object-fit:cover;border-radius:50%';
      prev.innerHTML='';prev.appendChild(img);
      toast('Image charg√©e !');
    }catch(e){toast(e.message,'err')}
    inp.value='';
  },
  async saveProfile(){
    const u=App.state.user;if(!u)return;
    const pseudo=document.getElementById('stPseudo').value.trim();
    const pc=document.getElementById('stPC').value;
    const status=document.getElementById('stStatusTxt').value.trim();
    document.getElementById('stPE').classList.remove('on');
    // Re-auth to verify password
    try{
      const cred=EmailAuthProvider.credential(u.email,pc);
      await reauthenticateWithCredential(fbAuth.currentUser,cred);
    }catch{document.getElementById('stPE').textContent='Mot de passe incorrect';document.getElementById('stPE').classList.add('on');return}
    if(pseudo.length<2){document.getElementById('stPE').textContent='Pseudo trop court';document.getElementById('stPE').classList.add('on');return}
    // Check pseudo uniqueness
    if(pseudo!==u.pseudo){
      const snap=await get(query(ref(db,'users'),orderByChild('pseudoLower'),equalTo(pseudo.toLowerCase())));
      if(snap.exists()){document.getElementById('stPE').textContent='Pseudo d√©j√† pris';document.getElementById('stPE').classList.add('on');return}
    }
    const updates={pseudo,pseudoLower:pseudo.toLowerCase(),customStatus:status,avaEmoji:document.querySelector('.aopt.on')?.textContent||u.avaEmoji,avaColor:document.querySelector('.sw.on')?.style.background||u.avaColor};
    if(this._pendingPic!==null)updates.avaPic=this._pendingPic;
    await update(ref(db,'users/'+u.id),updates);
    Object.assign(u,updates);App.updateUser();document.getElementById('stPC').value='';
    toast('Profil mis √† jour !');
  },
  async changePass(){
    const u=App.state.user;if(!u)return;
    const op=document.getElementById('stOP').value,np=document.getElementById('stNP').value,np2=document.getElementById('stNP2').value;
    document.getElementById('stPE2').classList.remove('on');
    if(np.length<6){document.getElementById('stPE2').textContent='6 caract√®res minimum';document.getElementById('stPE2').classList.add('on');return}
    if(np!==np2){document.getElementById('stPE2').textContent='Mots de passe diff√©rents';document.getElementById('stPE2').classList.add('on');return}
    try{
      const cred=EmailAuthProvider.credential(u.email,op);
      await reauthenticateWithCredential(fbAuth.currentUser,cred);
      await updatePassword(fbAuth.currentUser,np);
      ['stOP','stNP','stNP2'].forEach(id=>document.getElementById(id).value='');
      toast('Mot de passe chang√© !');
    }catch{document.getElementById('stPE2').textContent='Ancien mot de passe incorrect';document.getElementById('stPE2').classList.add('on')}
  }
};
window.Settings=Settings;

// ‚îÄ‚îÄ FILE HANDLER ‚îÄ‚îÄ
const FH={
  files:[],
  pick(){document.getElementById('fileInput').click()},
  onPick(inp){Array.from(inp.files).forEach(f=>{if(f.size>5*1024*1024){toast('Max 5MB','err');return}this.files.push(f)});this.renderPreview();inp.value=''},
  renderPreview(){
    const wrap=document.getElementById('fprev');wrap.innerHTML='';
    this.files.forEach((f,i)=>{
      const chip=document.createElement('div');chip.className='fchip';
      chip.innerHTML=`<span>${isImg(f.name)?'üñºÔ∏è':fIcon(f.name)}</span><span class="fn">${esc(f.name)}</span><span style="font-size:10px;color:var(--mu)">${fmtSize(f.size)}</span>`;
      const rm=document.createElement('button');rm.className='rm';rm.textContent='‚úï';rm.onclick=()=>{this.files.splice(i,1);this.renderPreview()};
      chip.appendChild(rm);wrap.appendChild(chip);
    });
  },
  readDataURL(f){return new Promise(r=>{const fr=new FileReader();fr.onload=e=>r(e.target.result);fr.readAsDataURL(f)})}
};
window.FH=FH;

// ‚îÄ‚îÄ EMOJI PICKER ‚îÄ‚îÄ
const EMOJI_CATS={
  'üòÄ Visages':['üòÄ','üòÉ','üòÑ','üòÅ','üòÜ','üòÖ','ü§£','üòÇ','üôÇ','üòâ','üòä','üòá','ü•∞','üòç','ü§©','üòò','üòã','üòú','ü§™','üòù','ü§ë','ü§ó','ü§î','üòê','üòè','üòí','üôÑ','üò¨','üòî','üò™','üò∑','ü§í','ü•µ','ü•∂','üòµ','ü•≥','üòé','üòï','üòü','üòÆ','üò≤','üò≥','ü•∫','üò¢','üò≠','üò±','üò©','üò´','üò§','üò°','üò†','ü§¨','üòà','üëø','üíÄ','üëª','ü§ñ'],
  'üëã Gestes':['üëã','ü§ö','üñêÔ∏è','‚úã','üëå','‚úåÔ∏è','ü§û','ü§ü','ü§ò','ü§ô','üëç','üëé','‚úä','üëä','üëè','üôå','üôè','üí™','ü´∂'],
  'üê∂ Animaux':['üê∂','üê±','üê≠','üê∞','ü¶ä','üêª','üêº','üê®','üêØ','ü¶Å','üêÆ','üê∑','üê∏','üêµ','üêî','üêß','ü¶Ü','ü¶Ö','ü¶â','üê∫','ü¶Ñ','ü¶ã','üê¢','üêç','üêô','ü¶à','üê¨','üê≥','ü¶ì','üêò','ü¶í'],
  'üçï Nourriture':['üçï','üçî','üçü','üåÆ','üç£','üç±','üçú','üçù','ü•ó','üç≥','ü•û','üå≠','üßÜ','üç∞','üéÇ','üßÅ','üç©','üç™','üç´','üç¨','üç≠','üç¶','üç∫','üç∏','üçπ','‚òï'],
  '‚öΩ Sport':['‚öΩ','üèÄ','üèà','‚öæ','üèê','üéæ','ü•ä','‚õ≥','üèπ','üèãÔ∏è','üèÜ','ü•á','üéØ','üé≥','üé≤','üéÆ','üß©'],
  'üöÄ Objets':['üöÄ','‚úàÔ∏è','üöó','üèéÔ∏è','üö≤','üõµ','üöÅ','üõ∏','‚õµ','üö¢','üíé','üì±','üíª','üì∑','üìû','üì∫','‚åö','üîã','üí°','üîë','üîí','üîß','‚öôÔ∏è'],
  'üí´ Symboles':['‚ù§Ô∏è','üß°','üíõ','üíö','üíô','üíú','üñ§','üíî','üíï','üíû','üåà','‚≠ê','üåü','‚ú®','üí´','‚ö°','üî•','üí•','‚ùÑÔ∏è','üå∏','üå∫','üåª','üçÄ','üåø','üçÅ','üå≤','üå¥'],
};
let curCat=Object.keys(EMOJI_CATS)[0];
const Picker={
  open:false,
  toggle(){this.open=!this.open;document.getElementById('picker').style.display=this.open?'block':'none';if(this.open)this.build(curCat)},
  close(){this.open=false;document.getElementById('picker').style.display='none'},
  build(cat){
    curCat=cat;
    const pc=document.getElementById('pcats');pc.innerHTML='';
    Object.keys(EMOJI_CATS).forEach(c=>{const btn=document.createElement('button');btn.className='pcat'+(c===cat?' on':'');btn.textContent=c;btn.onclick=e=>{e.stopPropagation();this.build(c)};pc.appendChild(btn)});
    const grid=document.getElementById('egrid');grid.innerHTML='';
    (EMOJI_CATS[cat]||[]).forEach(em=>{const c=document.createElement('div');c.className='ecell';c.textContent=em;c.onclick=e=>{e.stopPropagation();Msg.insertEmoji(em)};grid.appendChild(c)});
  },
  search(q){
    const grid=document.getElementById('egrid');grid.innerHTML='';
    const all=Object.values(EMOJI_CATS).flat();
    all.slice(0,200).forEach(em=>{const c=document.createElement('div');c.className='ecell';c.textContent=em;c.onclick=e=>{e.stopPropagation();Msg.insertEmoji(em)};grid.appendChild(c)});
  }
};
window.Picker=Picker;

// ‚îÄ‚îÄ FRIENDS ‚îÄ‚îÄ
const Friends={
  _listeners:{},
  tab(name,btn){
    document.querySelectorAll('.ftab:not(.add)').forEach(b=>b.classList.remove('on'));
    if(btn)btn.classList.add('on');
    this.render(name);
  },
  async sendRequest(){
    const pseudo=document.getElementById('afPseudo').value.trim();
    const err=document.getElementById('afErr');err.textContent='';err.classList.remove('on');
    if(!pseudo){err.textContent='Entre un pseudo';err.classList.add('on');return}
    const me=App.state.user;
    const snap=await get(query(ref(db,'users'),orderByChild('pseudoLower'),equalTo(pseudo.toLowerCase())));
    if(!snap.exists()){err.textContent='Utilisateur introuvable';err.classList.add('on');return}
    const targetData=Object.values(snap.val())[0];
    if(targetData.id===me.id){err.textContent='C\'est toi ! üòÖ';err.classList.add('on');return}
    // Check already friends
    const frSnap=await get(ref(db,'friends/'+me.id+'/'+targetData.id));
    if(frSnap.exists()){err.textContent='D√©j√† ami !';err.classList.add('on');return}
    // Check pending
    const pendSnap=await get(ref(db,'pending/'+targetData.id+'/'+me.id));
    if(pendSnap.exists()){err.textContent='Demande d√©j√† envoy√©e';err.classList.add('on');return}
    await set(ref(db,'pending/'+targetData.id+'/'+me.id),{fromId:me.id,fromPseudo:me.pseudo,ts:Date.now()});
    toast('Demande envoy√©e √† '+targetData.pseudo+' !');
    document.getElementById('afPseudo').value='';
    closeModal('addFriendModal');
  },
  async accept(fromId){
    const me=App.state.user;
    const userSnap=await get(ref(db,'users/'+fromId));
    if(!userSnap.exists())return;
    const sender=userSnap.val();
    await set(ref(db,'friends/'+me.id+'/'+fromId),{id:fromId,pseudo:sender.pseudo,ts:Date.now()});
    await set(ref(db,'friends/'+fromId+'/'+me.id),{id:me.id,pseudo:me.pseudo,ts:Date.now()});
    await remove(ref(db,'pending/'+me.id+'/'+fromId));
    toast('Vous √™tes maintenant amis avec '+sender.pseudo+' !');
    App.renderClist();this.render('pending');
  },
  async decline(fromId){
    await remove(ref(db,'pending/'+App.state.user.id+'/'+fromId));
    this.render('pending');
  },
  async remove(friendId){
    if(!confirm('Retirer cet ami ?'))return;
    const me=App.state.user;
    await remove(ref(db,'friends/'+me.id+'/'+friendId));
    await remove(ref(db,'friends/'+friendId+'/'+me.id));
    App.renderClist();this.render('all');toast('Ami retir√©');
  },
  async render(tab='online'){
    const body=document.getElementById('fbody');body.innerHTML='<div style="color:var(--mu);padding:20px;text-align:center;font-size:13px">Chargement...</div>';
    const me=App.state.user;if(!me)return;
    if(tab==='pending'){
      const snap=await get(ref(db,'pending/'+me.id));
      body.innerHTML='';
      if(!snap.exists()){body.innerHTML=emptyH('üì¨','Aucune demande en attente','Quand quelqu\'un t\'envoie une demande, elle appara√Æt ici !');return}
      const pends=snap.val();
      for(const [fromId,data] of Object.entries(pends)){
        const row=document.createElement('div');row.className='frow';
        const a={id:fromId,pseudo:data.fromPseudo,avaColor:'#7c5cfc',avaEmoji:'üòÄ'};
        const ava=mkAva(a,'lg');row.appendChild(ava);
        row.innerHTML+=`<div class="fri"><div class="frn">${esc(data.fromPseudo)}</div><div class="frs">Demande re√ßue</div></div>`;
        const btns=document.createElement('div');btns.className='frbtns';
        const acc=document.createElement('button');acc.className='icob';acc.style.color='var(--g)';acc.textContent='‚úì';acc.onclick=()=>this.accept(fromId);
        const dec=document.createElement('button');dec.className='icob';dec.style.color='var(--r)';dec.textContent='‚úó';dec.onclick=()=>this.decline(fromId);
        btns.append(acc,dec);row.appendChild(btns);body.appendChild(row);
      }
    } else {
      const snap=await get(ref(db,'friends/'+me.id));
      body.innerHTML='';
      if(!snap.exists()){body.innerHTML=emptyH('üë•','Aucun ami','Ajoutez des amis avec leur pseudo !');return}
      const friends=snap.val();
      for(const [fid] of Object.entries(friends)){
        const uSnap=await get(ref(db,'users/'+fid));if(!uSnap.exists())continue;
        const fr=uSnap.val();
        const row=document.createElement('div');row.className='frow';
        const ava=mkAva(fr,'lg');row.appendChild(ava);
        row.innerHTML+=`<div class="fri"><div class="frn">${esc(fr.pseudo)}</div><div class="frs">${fr.customStatus||'En ligne'}</div></div>`;
        const btns=document.createElement('div');btns.className='frbtns';
        const dm=document.createElement('button');dm.className='icob';dm.title='Message';dm.textContent='üí¨';dm.onclick=()=>App.openDM(fr);
        const rm=document.createElement('button');rm.className='icob';rm.title='Retirer';rm.textContent='‚úñ';rm.onclick=()=>this.remove(fid);
        btns.append(dm,rm);row.appendChild(btns);body.appendChild(row);
      }
    }
    // Update pending badge
    const pendSnap=await get(ref(db,'pending/'+me.id));
    const cnt=pendSnap.exists()?Object.keys(pendSnap.val()).length:0;
    document.getElementById('pendTab').textContent=cnt?'En attente ('+cnt+')':'En attente';
  }
};
window.Friends=Friends;

// ‚îÄ‚îÄ MESSAGES ‚îÄ‚îÄ
let _msgListener=null;
const Msg={
  onKey(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();this.send()}},
  insertEmoji(em){const inp=document.getElementById('msgInput');inp.value+=em;inp.focus();autoGrow(inp)},
  async send(){
    const inp=document.getElementById('msgInput');const txt=inp.value.trim();const files=[...FH.files];
    if(!txt&&!files.length)return;
    const chatId=App.state.chatId;if(!chatId)return;
    const u=App.state.user;
    const attachments=[];
    for(const f of files){
      if(f.size<2*1024*1024){const d=await FH.readDataURL(f);attachments.push({name:f.name,size:f.size,type:f.type,data:d})}
      else attachments.push({name:f.name,size:f.size,type:f.type,data:null,tooBig:true});
    }
    const msgRef=push(ref(db,'messages/'+chatId));
    await set(msgRef,{id:msgRef.key,authorId:u.id,authorName:u.pseudo,authorColor:u.avaColor||'#7c5cfc',authorEmoji:u.avaEmoji||'',authorPic:u.avaPic||null,text:txt||'',attachments:attachments.length?attachments:null,reactions:null,ts:Date.now()});
    FH.files=[];FH.renderPreview();inp.value='';inp.style.height='auto';
  },
  listen(chatId){
    // Remove old listener
    if(_msgListener){off(ref(db,'messages/'+_msgListener));_msgListener=null}
    document.getElementById('msgsArea').innerHTML='';
    _msgListener=chatId;
    onChildAdded(ref(db,'messages/'+chatId),(snap)=>{
      const msg=snap.val();this.renderMsg(msg);
      setTimeout(()=>{const a=document.getElementById('msgsArea');a.scrollTop=a.scrollHeight},50);
    });
  },
  async addReaction(chatId,msgId,emoji){
    const me=App.state.user;
    const rxnRef=ref(db,'messages/'+chatId+'/'+msgId+'/reactions/'+emoji+'/'+me.id);
    const snap=await get(rxnRef);
    if(snap.exists())await remove(rxnRef);
    else await set(rxnRef,true);
  },
  renderMsg(msg){
    const area=document.getElementById('msgsArea');
    if(document.querySelector('.mgroup[data-msgid="'+msg.id+'"]'))return; // already rendered
    const g=document.createElement('div');g.className='mgroup';g.dataset.msgid=msg.id;
    const rxnBtn=document.createElement('button');rxnBtn.className='rxnbtn';rxnBtn.textContent='üòä';
    const rxnPick=document.createElement('div');rxnPick.className='rxnpick';
    QUICK_RXNS.forEach(em=>{
      const c=document.createElement('div');c.className='rxncell';c.textContent=em;
      c.onclick=e=>{e.stopPropagation();rxnPick.classList.remove('on');this.addReaction(App.state.chatId,msg.id,em)};
      rxnPick.appendChild(c);
    });
    rxnBtn.onclick=e=>{e.stopPropagation();rxnPick.classList.toggle('on')};
    g.appendChild(rxnBtn);g.appendChild(rxnPick);
    g.addEventListener('contextmenu',e=>{
      e.preventDefault();
      const me=App.state.user;const isMe=msg.authorId===me.id;
      const items=QUICK_RXNS.slice(0,4).map(em=>({ico:em,label:'R√©agir '+em,action:()=>this.addReaction(App.state.chatId,msg.id,em)}));
      items.push('-');
      items.push({ico:'üìã',label:'Copier',action:()=>navigator.clipboard.writeText(msg.text)});
      if(isMe)items.push({ico:'üóëÔ∏è',label:'Supprimer',danger:true,action:async()=>{await remove(ref(db,'messages/'+App.state.chatId+'/'+msg.id));g.remove()}});
      CTX.show(e.clientX,e.clientY,items);
    });
    const uAuthor={id:msg.authorId,pseudo:msg.authorName,avaColor:msg.authorColor,avaEmoji:msg.authorEmoji,avaPic:msg.authorPic||null};
    const ava=mkAva(uAuthor,'lg');
    const body=document.createElement('div');body.className='mbody';
    const hdr=document.createElement('div');hdr.className='mhdr';
    hdr.innerHTML=`<span class="auth" style="color:${msg.authorColor||'var(--p)'}">${esc(msg.authorName)}</span><span class="ts">${fmtT(msg.ts)}</span>`;
    const txt=document.createElement('div');txt.className='mtxt';txt.textContent=msg.text||'';
    body.appendChild(hdr);body.appendChild(txt);
    if(msg.attachments){
      const wrap=document.createElement('div');wrap.className='mattach';
      (Array.isArray(msg.attachments)?msg.attachments:Object.values(msg.attachments)).forEach(att=>{
        if(att.tooBig){const d=document.createElement('div');d.className='fattach';d.innerHTML=`<span class="fi">üìÅ</span><div class="finfo"><div class="fname">${esc(att.name)}</div><div class="fsz">${fmtSize(att.size)} ¬∑ Trop grand</div></div>`;wrap.appendChild(d)}
        else if(att.data&&isImg(att.name)){const img=document.createElement('img');img.className='imgattach';img.src=att.data;img.alt=att.name;img.onclick=()=>{document.getElementById('lboxImg').src=att.data;document.getElementById('lbox').classList.add('on')};wrap.appendChild(img)}
        else if(att.data){const a=document.createElement('a');a.className='fattach';a.download=att.name;a.href=att.data;a.innerHTML=`<span class="fi">${fIcon(att.name)}</span><div class="finfo"><div class="fname">${esc(att.name)}</div><div class="fsz">${fmtSize(att.size)}</div></div><span>‚¨áÔ∏è</span>`;wrap.appendChild(a)}
      });
      body.appendChild(wrap);
    }
    const rxnWrap=document.createElement('div');rxnWrap.className='reactions';body.appendChild(rxnWrap);
    g.appendChild(ava);g.appendChild(body);area.appendChild(g);
    // Listen for reaction updates
    if(App.state.chatId){
      onValue(ref(db,'messages/'+App.state.chatId+'/'+msg.id+'/reactions'),(snap)=>{
        const me=App.state.user;rxnWrap.innerHTML='';
        if(!snap.exists())return;
        Object.entries(snap.val()).forEach(([emoji,users])=>{
          const cnt=Object.keys(users).length;if(!cnt)return;
          const r=document.createElement('div');r.className='rxn'+(users[me?.id]?' mine':'');
          r.innerHTML=emoji+'<span class="cnt">'+cnt+'</span>';
          r.onclick=()=>this.addReaction(App.state.chatId,msg.id,emoji);
          rxnWrap.appendChild(r);
        });
      });
    }
  }
};
window.Msg=Msg;

// ‚îÄ‚îÄ SERVERS ‚îÄ‚îÄ
let curChType='text';
const Servers={
  async create(){
    const icon=document.getElementById('srvIcon').value||'üåê';
    const name=document.getElementById('srvName').value.trim();
    document.getElementById('srvErr').classList.remove('on');
    if(!name){document.getElementById('srvErr').textContent='Nom requis';document.getElementById('srvErr').classList.add('on');return}
    const u=App.state.user;
    const srvRef=push(ref(db,'servers'));
    const srv={id:srvRef.key,code:genCode(),icon,name,ownerId:u.id,channels:{},createdAt:Date.now()};
    // Add default channels
    const c1key=push(ref(db,'servers/'+srvRef.key+'/channels')).key;
    const c2key=push(ref(db,'servers/'+srvRef.key+'/channels')).key;
    const c3key=push(ref(db,'servers/'+srvRef.key+'/channels')).key;
    srv.channels[c1key]={id:c1key,type:'text',name:'g√©n√©ral',order:0};
    srv.channels[c2key]={id:c2key,type:'text',name:'annonces',order:1};
    srv.channels[c3key]={id:c3key,type:'voice',name:'Vocal 1',order:2};
    await set(srvRef,srv);
    await set(ref(db,'members/'+srvRef.key+'/'+u.id),true);
    await set(ref(db,'userServers/'+u.id+'/'+srvRef.key),true);
    closeModal('addSrvModal');
    document.getElementById('srvIcon').value='';document.getElementById('srvName').value='';
    await App.renderSbar();App.openServer(srv);toast('Serveur cr√©√© ! üöÄ');
  },
  async join(){
    let code=document.getElementById('joinCode').value.trim().toUpperCase();
    if(code.includes('VORTEX.GG/'))code=code.split('VORTEX.GG/').pop();
    document.getElementById('joinErr').classList.remove('on');
    // Find server by code
    const snap=await get(query(ref(db,'servers'),orderByChild('code'),equalTo(code)));
    if(!snap.exists()){document.getElementById('joinErr').textContent='Code invalide';document.getElementById('joinErr').classList.add('on');return}
    const srv=Object.values(snap.val())[0];
    const u=App.state.user;
    const memSnap=await get(ref(db,'members/'+srv.id+'/'+u.id));
    if(memSnap.exists()){toast('D√©j√† membre !','err');return}
    await set(ref(db,'members/'+srv.id+'/'+u.id),true);
    await set(ref(db,'userServers/'+u.id+'/'+srv.id),true);
    closeModal('addSrvModal');document.getElementById('joinCode').value='';
    await App.renderSbar();App.openServer(srv);toast('Serveur rejoint !');
  },
  async leave(srv){
    if(!confirm('Quitter "'+srv.name+'" ?'))return;
    const u=App.state.user;
    await remove(ref(db,'members/'+srv.id+'/'+u.id));
    await remove(ref(db,'userServers/'+u.id+'/'+srv.id));
    App.showHome();await App.renderSbar();toast('Serveur quitt√©');
  },
  openSettings(srv){
    App.state.editSrv=srv;
    document.getElementById('seIcon').value=srv.icon||'üåê';
    document.getElementById('seName').value=srv.name||'';
    this.refreshChManage(srv);
    document.querySelectorAll('#srvSetModal .stab').forEach((b,i)=>b.classList[i===0?'add':'remove']('on'));
    ['srvGen','srvChs','srvInv'].forEach((id,i)=>document.getElementById(id).classList[i===0?'add':'remove']('on'));
    openModal('srvSetModal');
  },
  async save(){
    const srv=App.state.editSrv;if(!srv)return;
    const icon=document.getElementById('seIcon').value||srv.icon;
    const name=document.getElementById('seName').value.trim()||srv.name;
    await update(ref(db,'servers/'+srv.id),{icon,name});
    srv.icon=icon;srv.name=name;
    await App.renderSbar();App.renderClist();document.getElementById('cheadTitle').textContent=name;
    toast('Serveur mis √† jour !');
  },
  async del(){
    const srv=App.state.editSrv;if(!srv)return;
    if(!confirm('Supprimer "'+srv.name+'" ? Irr√©versible.'))return;
    await remove(ref(db,'servers/'+srv.id));
    await remove(ref(db,'messages/srv_'+srv.id));
    closeModal('srvSetModal');App.showHome();await App.renderSbar();toast('Serveur supprim√©');
  },
  async regen(){
    const srv=App.state.editSrv;if(!srv)return;
    const code=genCode();
    await update(ref(db,'servers/'+srv.id),{code});
    srv.code=code;document.getElementById('invLinkTxt').textContent=code;toast('Nouveau code g√©n√©r√© !');
  },
  chType(t,el){curChType=t;document.querySelectorAll('.chtype').forEach(x=>x.classList.remove('on'));el.classList.add('on')},
  async addCh(){
    const srv=App.state.editSrv;if(!srv)return;
    const name=document.getElementById('newCh').value.trim();
    document.getElementById('chErr').classList.remove('on');
    if(!name){document.getElementById('chErr').textContent='Nom requis';document.getElementById('chErr').classList.add('on');return}
    const chRef=push(ref(db,'servers/'+srv.id+'/channels'));
    const ch={id:chRef.key,type:curChType,name,order:Date.now()};
    await set(chRef,ch);
    if(!srv.channels)srv.channels={};
    srv.channels[chRef.key]=ch;
    document.getElementById('newCh').value='';
    App.renderClist();this.refreshChManage(srv);toast('Salon ajout√© !');
  },
  refreshChManage(srv){
    const list=document.getElementById('chManage');list.innerHTML='<div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--mu);margin-bottom:8px">Salons existants</div>';
    const channels=srv.channels?Object.values(srv.channels):[];
    channels.forEach(ch=>{
      const row=document.createElement('div');row.style.cssText='display:flex;align-items:center;gap:7px;padding:7px;background:var(--bg3);border:1px solid var(--bdr);border-radius:8px;margin-bottom:4px';
      row.innerHTML=`<span style="font-size:16px">${ch.type==='voice'?'üîä':'üí¨'}</span><span style="flex:1;font-size:13px;font-weight:500">${esc(ch.name)}</span>`;
      const d=document.createElement('button');d.textContent='üóë';d.style.cssText='background:none;border:none;color:var(--r);cursor:pointer;font-size:15px;padding:2px 6px;border-radius:4px';
      d.onclick=async()=>{
        if(!confirm('Supprimer "'+ch.name+'" ?'))return;
        await remove(ref(db,'servers/'+srv.id+'/channels/'+ch.id));
        delete srv.channels[ch.id];App.renderClist();this.refreshChManage(srv);
      };
      row.appendChild(d);list.appendChild(row);
    });
  }
};
window.Servers=Servers;

// ‚îÄ‚îÄ APP ‚îÄ‚îÄ
const App={
  state:{user:null,view:'home',dm:null,srv:null,ch:null,chatId:null,membOpen:false,editSrv:null},
  async launch(user){
    // Load full user profile from DB
    const snap=await get(ref(db,'users/'+user.uid));
    if(!snap.exists())return;
    this.state.user=snap.val();
    document.getElementById('loadingOverlay').style.display='none';
    document.getElementById('authWrap').style.display='none';
    document.getElementById('appWrap').classList.add('on');
    this.updateUser();await this.renderSbar();this.showHome();
  },
  updateUser(){
    const u=this.state.user;if(!u)return;
    const ava=document.getElementById('uAva');
    ava.style.background=u.avaColor||'#7c5cfc';
    if(u.avaPic){const img=document.createElement('img');img.src=u.avaPic;img.style.cssText='width:100%;height:100%;object-fit:cover;border-radius:50%';ava.innerHTML='';ava.appendChild(img);const dot=document.createElement('div');dot.className='dot on';ava.appendChild(dot)}
    else ava.innerHTML=(u.avaEmoji||(u.pseudo||'?')[0].toUpperCase())+'<div class="dot on"></div>';
    document.getElementById('uName').textContent=u.pseudo||'';
    document.getElementById('uStatus').textContent=u.customStatus||'En ligne';
  },
  async renderSbar(){
    const list=document.getElementById('srvList');list.innerHTML='';
    const u=this.state.user;if(!u)return;
    const snap=await get(ref(db,'userServers/'+u.id));
    if(!snap.exists()){document.getElementById('homeBtn').className='sico on';return}
    const srvIds=Object.keys(snap.val());
    for(const sid of srvIds){
      const ssnap=await get(ref(db,'servers/'+sid));if(!ssnap.exists())continue;
      const srv=ssnap.val();
      const ico=document.createElement('div');ico.className='sico'+(this.state.srv?.id===sid?' on':'');
      ico.title=srv.name;ico.textContent=srv.icon||'üåê';
      const pip=document.createElement('div');pip.className='spip';ico.appendChild(pip);
      ico.onclick=()=>this.openServer(srv);
      ico.addEventListener('contextmenu',e=>{
        e.preventDefault();
        const isOwner=srv.ownerId===u.id;
        const items=[{ico:'üîó',label:'Copier le code',action:()=>{navigator.clipboard.writeText(srv.code);toast('Code copi√© !')}}];
        if(isOwner)items.push({ico:'‚öôÔ∏è',label:'Param√®tres',action:()=>Servers.openSettings(srv)});
        items.push('-');
        if(isOwner)items.push({ico:'üóëÔ∏è',label:'Supprimer',danger:true,action:()=>{App.state.editSrv=srv;Servers.del()}});
        else items.push({ico:'üö™',label:'Quitter',danger:true,action:()=>Servers.leave(srv)});
        CTX.show(e.clientX,e.clientY,items);
      });
      list.appendChild(ico);
    }
    document.getElementById('homeBtn').className='sico'+(['home','dm'].includes(this.state.view)?' on':'');
  },
  async renderClist(){
    const list=document.getElementById('clist');list.innerHTML='';
    const u=this.state.user;if(!u)return;
    if(this.state.view==='server'&&this.state.srv){
      const srv=this.state.srv;
      const ssnap=await get(ref(db,'servers/'+srv.id));
      const freshSrv=ssnap.exists()?ssnap.val():srv;
      const channels=freshSrv.channels?Object.values(freshSrv.channels):[];
      const text=channels.filter(c=>c.type==='text');
      const voice=channels.filter(c=>c.type==='voice');
      if(text.length){
        const cat=document.createElement('div');cat.className='ccat';cat.textContent='üí¨ Salons texte';list.appendChild(cat);
        text.forEach(ch=>{const el=this._chItem(ch,this.state.ch?.id===ch.id);el.onclick=()=>this.openChannel(ch);list.appendChild(el)});
      }
      if(voice.length){
        const cat=document.createElement('div');cat.className='ccat';cat.textContent='üîä Salons vocaux';list.appendChild(cat);
        voice.forEach(ch=>{const el=this._chItem(ch,Voice.st.inVoice&&Voice.st.ch?.id===ch.id);el.onclick=()=>this.openChannel(ch);list.appendChild(el)});
      }
    } else {
      const pendSnap=await get(ref(db,'pending/'+u.id));
      const pendCnt=pendSnap.exists()?Object.keys(pendSnap.val()).length:0;
      const cat=document.createElement('div');cat.className='ccat';
      cat.innerHTML=`<span>Messages Priv√©s</span>${pendCnt?`<span style="background:var(--r);color:#fff;border-radius:10px;padding:1px 7px;font-size:10px;margin-left:4px">${pendCnt}</span>`:''}`;
      list.appendChild(cat);
      const frSnap=await get(ref(db,'friends/'+u.id));
      if(frSnap.exists()){
        for(const [fid] of Object.entries(frSnap.val())){
          const uSnap=await get(ref(db,'users/'+fid));if(!uSnap.exists())continue;
          const fr=uSnap.val();
          const el=document.createElement('div');el.className='dmitem'+(this.state.dm?.id===fid?' on':'');
          const ava=mkAva(fr);el.appendChild(ava);
          el.innerHTML+=`<div class="dminfo"><div class="dmname">${esc(fr.pseudo)}</div><div class="dmstat">${fr.customStatus||'En ligne'}</div></div>`;
          el.onclick=()=>this.openDM(fr);list.appendChild(el);
        }
      }
    }
  },
  _chItem(ch,active){const el=document.createElement('div');el.className='citem'+(active?' on':'');el.innerHTML=`<span class="ico">${ch.type==='voice'?'üîä':'üí¨'}</span><span class="lbl">${esc(ch.name)}</span>`;return el},
  _showFriends(){
    document.getElementById('fhead').style.display='flex';document.getElementById('fbody').style.display='block';
    document.getElementById('mhead').style.display='none';document.getElementById('msgsArea').style.display='none';document.getElementById('iwrap').style.display='none';
    document.getElementById('vPanel').classList.remove('on');
  },
  showHome(){
    this.state.view='home';this.state.srv=null;this.state.ch=null;this.state.chatId=null;this.state.dm=null;
    document.getElementById('cheadTitle').textContent='Messages Priv√©s';
    document.getElementById('cheadBtn').style.display='none';
    document.getElementById('csrch').style.display='block';
    document.getElementById('inviteBtn').style.display='none';
    this._showFriends();this.renderSbar();this.renderClist();Friends.render('online');Picker.close();
  },
  openServer(srv){
    this.state.view='server';this.state.srv=srv;this.state.dm=null;
    document.getElementById('cheadTitle').textContent=srv.name;
    document.getElementById('cheadBtn').style.display='block';
    document.getElementById('csrch').style.display='none';
    document.getElementById('fhead').style.display='none';
    document.getElementById('inviteBtn').style.display='block';
    this.renderSbar();this.renderClist();
    const channels=srv.channels?Object.values(srv.channels):[];
    const firstText=channels.find(c=>c.type==='text');
    if(firstText)this.openChannel(firstText);
    else{document.getElementById('mhead').style.display='none';document.getElementById('msgsArea').style.display='none';document.getElementById('iwrap').style.display='none'}
  },
  openChannel(ch){
    this.state.ch=ch;
    if(ch.type==='voice'){Voice.joinVoice(this.state.srv,ch);this.renderClist();return}
    const chatId='srv_'+this.state.srv.id+'_'+ch.id;this.state.chatId=chatId;
    document.getElementById('fhead').style.display='none';document.getElementById('fbody').style.display='none';
    document.getElementById('mhead').style.display='flex';document.getElementById('msgsArea').style.display='block';document.getElementById('iwrap').style.display='block';
    document.getElementById('mhAva').style.background='var(--p)';document.getElementById('mhAva').textContent='üí¨';
    document.getElementById('mhName').textContent='# '+ch.name;
    document.getElementById('mhSub').textContent=this.state.srv.name;
    document.getElementById('msgInput').placeholder='Envoyer dans #'+ch.name;
    this.renderClist();
    const area=document.getElementById('msgsArea');
    area.innerHTML=`<div class="wscreen"><div style="font-size:48px"># ${esc(ch.name)}</div><h2>Bienvenue dans #${esc(ch.name)}</h2><p>D√©but du salon</p></div>`;
    Msg.listen(chatId);Picker.close();
  },
  openDM(fr){
    this.state.view='dm';this.state.dm=fr;this.state.srv=null;this.state.ch=null;
    const chatId='dm_'+[this.state.user.id,fr.id].sort().join('_');this.state.chatId=chatId;
    document.getElementById('fhead').style.display='none';document.getElementById('fbody').style.display='none';
    document.getElementById('mhead').style.display='flex';document.getElementById('msgsArea').style.display='block';document.getElementById('iwrap').style.display='block';
    document.getElementById('inviteBtn').style.display='none';
    const mhA=document.getElementById('mhAva');
    mhA.style.background=fr.avaColor||'#7c5cfc';
    if(fr.avaPic){const img=document.createElement('img');img.src=fr.avaPic;img.style.cssText='width:100%;height:100%;object-fit:cover;border-radius:50%';mhA.innerHTML='';mhA.appendChild(img)}
    else mhA.textContent=fr.avaEmoji||(fr.pseudo||'?')[0].toUpperCase();
    document.getElementById('mhName').textContent=fr.pseudo||'';
    document.getElementById('mhSub').textContent=fr.customStatus||'Message priv√©';
    document.getElementById('msgInput').placeholder='Envoyer √† '+fr.pseudo;
    this.renderSbar();this.renderClist();
    const area=document.getElementById('msgsArea');
    area.innerHTML=`<div class="wscreen"><div style="font-size:56px">${fr.avaEmoji||'üë§'}</div><h2>${esc(fr.pseudo)}</h2><p>D√©but de votre conversation avec <strong>${esc(fr.pseudo)}</strong></p></div>`;
    Msg.listen(chatId);Picker.close();
  },
  clickHead(){if(this.state.srv)Servers.openSettings(this.state.srv)},
  showInvite(){
    const srv=this.state.srv;if(!srv)return;
    document.getElementById('invModalLink').textContent=srv.code;
    openModal('inviteModal');
  },
  toggleMembers(){
    this.state.membOpen=!this.state.membOpen;
    document.getElementById('msidebar').classList.toggle('on',this.state.membOpen);
    if(this.state.membOpen)this.renderMembers();
  },
  async renderMembers(){
    const list=document.getElementById('mslist');list.innerHTML='';
    const u=this.state.user;
    let mems=[];
    if(this.state.srv){
      const snap=await get(ref(db,'members/'+this.state.srv.id));
      if(snap.exists()){
        for(const uid of Object.keys(snap.val())){
          const us=await get(ref(db,'users/'+uid));if(us.exists())mems.push(us.val());
        }
      }
    } else if(this.state.dm)mems=[u,this.state.dm];
    else mems=[u];
    const hd=document.createElement('div');hd.style.cssText='font-size:10px;font-weight:700;text-transform:uppercase;color:var(--mu);letter-spacing:1px;padding:4px 9px 8px;margin-top:4px';
    hd.textContent='EN LIGNE ‚Äî '+mems.length;list.appendChild(hd);
    mems.forEach(m=>{
      const el=document.createElement('div');el.className='msitem';
      const a=mkAva(m);el.appendChild(a);
      const info=document.createElement('div');
      info.innerHTML=`<div class="mn">${esc(m.pseudo)}${m.id===this.state.srv?.ownerId?' <span style="font-size:10px;color:var(--y)">üëë</span>':''}</div><div class="ms2">${m.customStatus||'En ligne'}</div>`;
      el.appendChild(info);list.appendChild(el);
    });
  }
};
window.App=App;

// ‚îÄ‚îÄ AUTH STATE LISTENER ‚îÄ‚îÄ
onAuthStateChanged(fbAuth, async(user)=>{
  if(user){
    await App.launch(user);
  } else {
    document.getElementById('loadingOverlay').style.display='none';
    document.getElementById('authWrap').style.display='flex';
    document.getElementById('appWrap').classList.remove('on');
    Auth.showRegister();
  }
});

// ‚îÄ‚îÄ KEYBOARD SHORTCUTS ‚îÄ‚îÄ
document.addEventListener('keydown',e=>{
  if(e.key!=='Enter')return;
  if(document.getElementById('loginForm').style.display!=='none'&&document.activeElement!==document.getElementById('msgInput'))Auth.login();
});

</script>
</body>
</html>
